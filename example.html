<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TopoJSON US Counties Example</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 28px;
      color: #333;
    }

    .subtitle {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .stats {
      display: flex;
      gap: 30px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
      font-size: 14px;
    }

    .stat {
      display: flex;
      flex-direction: column;
    }

    .stat-label {
      color: #666;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      color: #333;
      font-size: 20px;
      font-weight: 600;
      margin-top: 4px;
    }

    #map {
      width: 100%;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
    }

    .county {
      fill: #e0e0e0;
      stroke: #fff;
      stroke-width: 0.5px;
    }

    .county:hover {
      fill: #4a90e2;
      cursor: pointer;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error {
      color: #d32f2f;
      padding: 20px;
      background: #ffebee;
      border-radius: 4px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>TopoJSON US Counties Visualization</h1>
    <div class="subtitle">
      Rendering 3,231 US counties using D3 and the TopoJSON library
    </div>

    <div class="stats" id="stats" style="display: none;">
      <div class="stat">
        <span class="stat-label">Counties</span>
        <span class="stat-value" id="county-count">-</span>
      </div>
      <div class="stat">
        <span class="stat-label">Arcs</span>
        <span class="stat-value" id="arc-count">-</span>
      </div>
      <div class="stat">
        <span class="stat-label">File Size</span>
        <span class="stat-value" id="file-size">-</span>
      </div>
      <div class="stat">
        <span class="stat-label">Quantized</span>
        <span class="stat-value" id="quantized">-</span>
      </div>
    </div>

    <div id="map">
      <div class="loading">Loading US counties data...</div>
    </div>
  </div>

  <!-- D3.js v7 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- TopoJSON Client -->
  <script src="https://d3js.org/topojson.v3.min.js"></script>

  <script>
    // Configuration
    const width = 1140;
    const height = 600;

    // Create SVG
    const svg = d3.select('#map')
      .html('') // Clear loading message
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .attr('viewBox', `0 0 ${width} ${height}`);

    // Create a group for the map
    const g = svg.append('g');

    // Define projection for US map
    const projection = d3.geoAlbersUsa()
      .scale(1300)
      .translate([width / 2, height / 2]);

    const path = d3.geoPath()
      .projection(projection);

    // Load the TopoJSON data
    fetch('./counties-10m.json')
      .then(response => {
        if (!response.ok) {
          throw new Error(`Failed to load counties-10m.json. Please run the example.js first to download the data file.`);
        }
        return response.json();
      })
      .then(topology => {
        // Show statistics
        const countyCount = topology.objects.counties.geometries.length;
        const arcCount = topology.arcs.length;
        const fileSize = JSON.stringify(topology).length;
        const quantized = !!topology.transform;

        document.getElementById('county-count').textContent = countyCount.toLocaleString();
        document.getElementById('arc-count').textContent = arcCount.toLocaleString();
        document.getElementById('file-size').textContent = `${(fileSize / 1024).toFixed(1)} KB`;
        document.getElementById('quantized').textContent = quantized ? 'Yes' : 'No';
        document.getElementById('stats').style.display = 'flex';

        // Convert TopoJSON to GeoJSON
        const counties = topojson.feature(topology, topology.objects.counties);

        // Draw counties
        g.selectAll('path')
          .data(counties.features)
          .enter()
          .append('path')
          .attr('class', 'county')
          .attr('d', path)
          .append('title')
          .text(d => d.properties.name || 'County');

        console.log('Map rendered successfully');
        console.log(`Rendered ${countyCount.toLocaleString()} counties`);
        console.log(`Using ${arcCount.toLocaleString()} arcs from TopoJSON`);
      })
      .catch(error => {
        console.error('Error loading TopoJSON:', error);
        document.getElementById('map').innerHTML = `
          <div class="error">
            <strong>Error loading data:</strong> ${error.message}
            <br><br>
            <strong>Solution:</strong> Run <code>node example.js</code> first to download the counties-10m.json file.
          </div>
        `;
      });
  </script>
</body>
</html>
